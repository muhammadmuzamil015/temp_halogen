node('J-RASP4-1') {
    stage('Clean Workspace') {
        cleanWs()
    }
    stage('Clone Repository') {
        // Checkout the SCM (Git repository)
        checkout scm
    }
    stage('Run Tests on raspi4 (Raspberry Pi 4)') {
        // Run the performance tests on Raspberry Pi 4
        sh '''#!/bin/bash
            ./run_tests_performance.sh raspi4
        '''
    }
    stage('Archive and Stash Results from raspi4') {
        // Archive the performance results from Raspberry Pi 4
        archiveArtifacts artifacts: 'performance_results_raspi4.csv', allowEmptyArchive: true
        // Stash the results for use in another stage
        stash includes: 'performance_results_raspi4.csv', name: 'raspi4-results'
    }
}

node('J-BPF3-1') {
    stage('Clean Workspace') {
        cleanWs()
    }
    stage('Clone Repository') {
        // Checkout the SCM (Git repository)
        checkout scm
    }
    stage('Unstash Results and Run Tests on bpif3 (Banana Pi F3)') {
        // Unstash the results from raspi4
        unstash 'raspi4-results'
        // Run the performance tests on bpif3
        sh '''#!/bin/bash
            ./run_tests_performance.sh bpif3
        '''
    }
    stage('Archive Results from bpif3') {
        // Archive the performance results from bpif3
        archiveArtifacts artifacts: 'performance_results_bpif3.csv', allowEmptyArchive: true
    }
    stage('Generate Performance Comparison Graph') {
        // Generate the performance comparison graph
        sh '''#!/bin/bash
            ./generate_performance_comparison_graph.sh performance_results_raspi4.csv performance_results_bpif3.csv
        '''
    }
    stage('Archive Performance Comparison Graph') {
        // Archive the generated graph
        archiveArtifacts artifacts: 'performance_comparison_*.png', allowEmptyArchive: true
    }
}
